name: Build APK from ZIP upload

on:
  push:
    branches: ["main"]
    paths:
      - "uploads/**/*.zip"
      - ".github/workflows/build_from_zip.yml"
  workflow_dispatch:

concurrency:
  group: build-from-zip-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      # ✅ FIX: jangan pakai flutter-version: "stable"
      # Pakai channel: stable saja supaya tidak error.
      - name: Setup Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Show Flutter version
        run: flutter --version

      - name: Pick latest ZIP in uploads/
        id: pickzip
        shell: bash
        run: |
          set -e
          ZIP_FILE="$(ls -t uploads/*.zip 2>/dev/null | head -n 1 || true)"
          if [ -z "$ZIP_FILE" ]; then
            echo "❌ Tidak ada file .zip di folder uploads/"
            echo "➡️ Upload ZIP ke uploads/ lalu commit."
            exit 1
          fi
          echo "zip_path=$ZIP_FILE" >> "$GITHUB_OUTPUT"
          echo "✅ Using ZIP: $ZIP_FILE"

      - name: Prepare workspace and unzip
        shell: bash
        run: |
          set -e
          rm -rf _work
          mkdir -p _work/app
          unzip -q "${{ steps.pickzip.outputs.zip_path }}" -d _work/app

          echo "== After unzip =="
          ls -la _work/app

          # Jika ZIP isinya hanya 1 folder root (misal: warung_sayur/), pindahkan isinya ke _work/app
          TOP_DIR="$(find _work/app -mindepth 1 -maxdepth 1 -type d | head -n 1 || true)"
          ITEM_COUNT="$(find _work/app -mindepth 1 -maxdepth 1 | wc -l | tr -d ' ')"

          if [ "$ITEM_COUNT" = "1" ] && [ -n "$TOP_DIR" ] && [ -d "$TOP_DIR" ]; then
            echo "✅ Single top-level folder detected: $TOP_DIR"
            shopt -s dotglob
            mv "$TOP_DIR"/* _work/app/
            rm -rf "$TOP_DIR"
          fi

          echo "== Workspace root =="
          ls -la _work/app

          if [ ! -f "_work/app/pubspec.yaml" ]; then
            echo "❌ pubspec.yaml tidak ditemukan di root project setelah unzip."
            echo "➡️ Pastikan ZIP berisi project Flutter dan pubspec.yaml ada di root."
            exit 1
          fi

      - name: Ensure Android platform exists
        shell: bash
        run: |
          set -e
          cd _work/app
          if [ ! -d "android" ]; then
            echo "android/ tidak ada. Generate platform android..."
            flutter create --platforms=android .
          fi

      - name: Flutter pub get
        shell: bash
        run: |
          set -e
          cd _work/app
          flutter pub get

      - name: Run build_runner (optional)
        shell: bash
        run: |
          set -e
          cd _work/app
          if grep -q "build_runner" pubspec.yaml; then
            echo "build_runner terdeteksi. Jalankan codegen..."
            dart run build_runner build --delete-conflicting-outputs
          else
            echo "build_runner tidak ada. Skip."
          fi

      - name: Build APK (release)
        shell: bash
        run: |
          set -e
          cd _work/app
          flutter build apk --release

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: _work/app/build/app/outputs/flutter-apk/app-release.apk
